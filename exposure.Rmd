---
title: "R Notebook"
author: "Christian Diener <cdiener@systemsbiology.org>"
output: html_notebook
---

# Effect of exposure length

## Data preparation

We will start by reading our data and required libraries.

```{r}
devtools::load_all("~/code/mbtools")

ps <- readRDS("data/exposure_exp.rds")

total <- subset_samples(ps, Spore == 0)
resp <- sample_data(total)$Response
levels(resp) <- c("control", "non-responder", "responder")
sample_data(total)$Response <- resp
```

We sill start by building up a dataframe that combines phyla abundances and sample metadata.

```{r}
phyla <- taxa_count(total, "phylum")

sdata <- as.data.table(as(sample_data(total), "data.frame"))
phyla <- phyla[sdata, on=c(sample="SampleID")]
head(phyla)
```

# Phyla abundances

## By exposure

First we have to assemble the relative abundances for controls.

```{r}
control <- phyla[Exposure == 0]
control[, relative := reads / sum(reads, na.rm=T)]

high_taxa <- phyla[Day - Exposure == 0, .(taxa=taxa, rel=reads / sum(reads)), by="sample"][rel > 1e-3, unique(taxa)] 
```

We will plot a reference bar chart for those, removing all phyla that contribute less than 0.1% of the total reads.

```{r, fig.height=4, fig.width=1.5}
pl <- ggplot(control[taxa %in% high_taxa], aes(x=factor(Exposure), y=relative, fill=taxa)) + 
  geom_bar(stat="identity") + scale_y_continuous(labels=scales::percent) +
  theme_bw() + labs(x="antibiotic exposure [days]", y="relative abundance") +
  facet_wrap(~ Response) + guides(fill = "none") + labs(x="")
ggsave("figures/control_exposure.png", height=4, width=1.5, dpi=300)
pl
```

Now we will do the same thing for the responders and non-responders.

```{r, fig.height=4, fig.width=8}
treated <- phyla[Exposure > 0 & Day - Exposure == 0]
treated[, relative := reads / sum(reads), by=c("Exposure", "Response")]

pl <- ggplot(treated[taxa %in% high_taxa], aes(x=factor(Exposure), y=relative, fill=taxa)) + 
  geom_bar(stat="identity") + scale_y_continuous(labels=scales::percent) +
  facet_wrap(~ Response) + theme_bw() +
  labs(x="", y="", fill="phylum")
ggsave("figures/treatment_exposure.png", height=4, width=8, dpi=300)
pl
```

We can see that most of the Cyanobacteria and Proteobacteria are actually Chloroplasts and Mitochondria:

```{r}
responders <- subset_samples(total, Response == "responder")
cyano_proteo <- subset_taxa(responders, 
                            phylum %in% c("Cyanobacteria", "Proteobacteria"))
class <- taxa_count(cyano_proteo, "class")[order(-reads), sum(reads), by = taxa]
fam <- taxa_count(cyano_proteo, "family")[order(-reads), sum(reads), by = taxa]
print(class[, .(taxa, relative = V1 / sum(V1))])
print(fam[, .(taxa, relative = V1 / sum(V1))])
```

## Summarized

```{r, fig.width=4, fig.height=5}
library(gridExtra)

treated <- phyla[Exposure >= 0 & Day - Exposure == 0]
treated[, relative := reads / sum(reads), by="Response"]

bars <- ggplot(treated[taxa %in% high_taxa], aes(x=Response, y=relative, fill=taxa)) + 
  geom_bar(stat="identity") + scale_y_continuous(labels=scales::percent) +
  theme_bw() + theme(axis.text.x = element_text(angle=30, hjust=1, vjust=1)) +
  labs(x="", y="relative abundance", fill="phylum")
after_exposure <- sdata[Exposure > 0 & Day - Exposure == 0]
resp_counts <- after_exposure[, table(Response, Exposure)][2:3, ]
tbl <- tableGrob(resp_counts, )
pl <- grid.arrange(bars, tbl, nrow=2, as.table=T, heights=c(3, 1))
ggsave("figures/summary_exposure.svg", plot = pl, height=6, width=4)
pl
```

And the corresponding Fisher test:

```{r}
fisher.test(resp_counts) %>% print
```

# Beta diversity

We are interested in the beta diversity between samples after treatment, so we will start by selecting a subset of those
and calculating the ordination. We will look at the sequencing depth to get a decent depth for rarefaction.

```{r}
after_treat <- subset_samples(total, Day - Exposure > 0)
sample_sums(after_treat) %>% summary
```

Okay so we can easily rarefy to 15k reads.

```{r}
ord <- rarefy_even_depth(after_treat, 10000) %>% ordinate(., method="PCoA", distance = "bray")
sda <- sample_data(after_treat)
sample_data(after_treat)$since_treatment <- factor(sda$Day - sda$Exposure)

pl <- plot_ordination(after_treat, ord, color = "Response") +
      geom_text(aes(label = since_treatment), size=3, vjust=1, nudge_y=-0.01) +
      stat_ellipse(aes(group=Response), type="t") +
      labs(shape = "since treatment [days]") + theme_bw()

ggsave("figures/post_treatment_pcoa_exposure.svg", width=6, height=4)
pl  
```

# Corresponding PERMANOVA

```{r}
library(vegan)

ps <- subset_samples(after_treat, Response != "responder") %>% rarefy_even_depth(., 10000)
counts <- as.matrix(taxa_count(ps, NA))
sda <- as(sample_data(ps), "data.frame")
permanova <- adonis(counts ~ since_treatment*Response, data = sda)
permanova
```

# Gained/lost taxa

We will now track which taxa where gained or lost in each mouse over the treatment course.

```{r}
asvs <- taxa_count(total, NA)
asvs <- asvs[sdata, on=c(sample="SampleID")][Day %in% c(0, 32)]
asvs
```

Now lets us assign which ASVs have persisted, were gained or lost.

```{r}
status <- function(dt) {
  if (nrow(dt) == 2) return("persisted")
  if (nrow(dt) == 1 && dt$Day == 0) return("lost")
  return("gained")
}

history <- asvs[reads > 0, .(status = status(.SD), taxon=taxa[1], mouse=Mouse[1], exposure=Exposure[1], response=Response[1]), by=c("Mouse", "taxa")]
status_counts <- history[, .(n=.N, exposure=exposure[1], response=response[1]), by=c("mouse", "status")]
status_counts[, exposure := factor(exposure)]
levels(status_counts$response) <- c("control", "non-responder", "responder")
```

Now let's plot all of that:

```{r, fig.height=3, fig.width=8}
pl <- ggplot(status_counts, aes(x=response, y=n, group=exposure, color=exposure)) +
  geom_boxplot(col="gray", aes(group=response), outlier.shape = NA) +
  geom_point(position=position_dodge(width=0.6)) + 
  facet_wrap(~ status) + theme_bw() + theme(axis.text.x = element_text(angle=30, hjust=1, vjust=1)) +
  labs(x="", y="ASVs [count]", color="exposure [days]")
ggsave("figures/avs_history.svg", height=3, width=8)
pl
```

And the corresponding tests:

control vs. non-responder

```{r, message=FALSE}
for (lev in status_counts[, unique(status)]) {
  cat(lev)
  pairwise.wilcox.test(status_counts[status == lev, n], 
                       status_counts[status == lev, response], 
                       p.adjust.method = "bonferroni") %>% print
}
```

# Time courses

## Shannon index

```{r, fig.width=6, fig.height=4}
shannon <- estimate_richness(rarefy_even_depth(total, 10000), measures="Shannon")
shannon <- data.table(sample = rownames(shannon), shannon=shannon[, 1])
shannon <- shannon[sdata, on=c(sample="SampleID")]
shannon[Day>=0 & Day < 32, Day := Day - Exposure]

pl <- ggplot(shannon[Day >= -1 & Day < 10], aes(x=Day, y=shannon, color=Response)) + 
  #geom_line(alpha=0.25, aes(group=Mouse)) +  
  stat_summary(fun.data=mean_sdl, fun.args=list(mult=1), geom="pointrange") +
  stat_summary(fun.data=mean_sdl, fun.args=list(mult=1), geom="line") +
  xlim(-1, 8) + theme_bw() + 
  labs(y = "alpha diversity [Shannon index]", x = "days after treatment")
ggsave("figures/shannon_time.svg", width = 6, height = 4)
pl
```

## Select phyla

```{r, fig.height = 4, fig.width = 6}
shifted <- phyla[Day - Exposure >= 0 & Day <= 32]
shifted[, Day := Day - Exposure]
shifted[, relative := reads / sum(reads), by="sample"]
#shifted <- shifted[Day < 10]

pl <- ggplot(shifted[taxa %in% c("Bacteroidetes", "Firmicutes")], aes(x=Day, y=relative, col=taxa)) +
  geom_point(alpha=0.5) + scale_y_continuous(labels = scales::percent) +
  geom_line(aes(group=interaction(Mouse, taxa)), alpha=0.5) + 
  facet_wrap(~ Response, nrow = 3, strip.position = "right", ) + theme_bw() +
  labs(x = "days after treatment", y = "relative abundance")
ggsave("figures/bac_firm_time.svg", width = 6, height = 4)
pl
```
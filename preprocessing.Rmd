---
title: "Preprocessing of the data"
author: "Christian Diener <cdiener@systemsbioogy.org>"
output: html_notebook
---

# Converting to a phyloseq object

Both experiments were processed the same way so we can write a single function 
to read both experiments.

```{r}
library(stringr)
devtools::load_all("~/code/mbtools")

qiime2phyloseq <- function(path) {
  feature_table <- read.csv(file.path(path, "feature_table.csv"), 
                            check.names = F, row.names = 1) %>% t()
  sample_meta <- read.table(file.path(path, "metadata.tsv"), 
                            comment.char = "#", header = 1)
  rownames(sample_meta) <- sample_meta[, 1]
  taxa <- read.table(file.path(path, "taxonomy.tsv"), sep = "\t", header = 1)
  taxa_meta <- str_replace_all(taxa$Taxon, "\\w__", "") %>% 
               str_split_fixed(., "; ", n = 7)
  taxa_meta[taxa_meta == ""] <- NA
  colnames(taxa_meta) <- c("kingdom", "phylum", "class", "order", 
                           "family", "genus", "species")
  rownames(taxa_meta) <- taxa[, 1]
  
  ps <- phyloseq(otu_table(feature_table, taxa_are_rows = F),
                 tax_table(taxa_meta),
                 sample_data(sample_meta))
  ps
}
```

# duration experiment

We will start by reading the DADA2 results and metadata and bundling everything
in a phyloseq object.

```{r}
dada <- readRDS("data/duration/dada2.rds")
meta <- read.table("data/duration/metadata.tsv", 
                   comment.char = "#", header = 1)
rownames(meta) <- meta$Description
meta <- meta[rownames(dada$feature_table), ]
duration <- phyloseq(otu_table(dada$feature_table, taxa_are_rows = FALSE),
                     tax_table(dada$taxonomy),
                     sample_data(meta))
```

We will extract the duration durations from the sample names.

```{r}
map <- c(cnt = "control", non = "resistor", res = "non-resistor")

sdata <- sample_data(duration)
sdata$duration <- str_replace(sdata$Mouse, "[A-Z]", "") %>% as.numeric()
sdata$TimepointCat <- "before"
sdata$TimepointCat[sdata$Day == sdata$duration] <- "during"
sdata$TimepointCat[sdata$Day > sdata$duration] <- "after"
sdata$TimepointCat[sdata$Response == "cnt"] <- "before"
sdata$TimepointCat <- factor(sdata$TimepointCat, 
                             levels = c("before", "during", "after"))
sdata$Response <- factor(map[as.character(sdata$Response)], levels = map)
sample_data(duration) <- sdata
```

We will save the phyloseq object for further analyses.

```{r}
saveRDS(duration, "data/duration_exp.rds")
```

# Seaweed experiment

Again we start by adding the metadata and bundling as a phyloseq object.

```{r}
dada <- readRDS("data/seaweed/dada2.rds")
meta <- read.table("data/seaweed/metadata.tsv", 
                   comment.char = "#", header = 1)
rownames(meta) <- tolower(meta$CategoricalID)
meta <- meta[rownames(dada$feature_table), ]
seaweed <- phyloseq(otu_table(dada$feature_table, taxa_are_rows = FALSE),
                    tax_table(dada$taxonomy),
                    sample_data(meta))
```

Groups A and B received no seaweed in their diet whereas groups C and D did. We will
also remove 4 samples where the diet was switched right before antibiotics (internal controls).

```{r}
sample_data(seaweed)$seaweed <- sample_data(seaweed)$Group %in% c("C", "D")
sample_data(seaweed)$CategoricalID <- tolower(sample_data(seaweed)$CategoricalID)
seaweed <- subset_samples(seaweed, !(Subject %in% c("A9", "A10", "C9", 
                                                    "C10", "X1", "X2", "Y1", 
                                                    "Y2")))
```

Let's clean up annotations and add some variables:

```{r}
sdata <- as(sample_data(seaweed), "data.frame")
sdata$TimepointCat <- "before"
sdata$TimepointCat[sdata$Days == 31] <- "during"
sdata$TimepointCat[sdata$Days > 31] <- "after"
sdata$TimepointCat[sdata$Response == "cnt"] <- "before"
sdata$TimepointCat <- factor(sdata$TimepointCat, 
                             levels = c("before", "during", "after"))
sdata$Response <- factor(map[as.character(sdata$Response)], 
                         levels = map)
sample_data(seaweed) <- sdata
```

We will also merge in the qPCR cycle time (Cq or Ct values):

```{r}
Ct <- read.table("data/seaweed/qpcr_data.tsv", header = TRUE)
names(Ct) <- c("CategoricalID", "Ct")
merged <- merge(sdata, Ct, by="CategoricalID")
rownames(merged) <- merged$CategoricalID
sample_data(seaweed) <- merged
```

We will save the phyloseq object for further analyses.

```{r}
saveRDS(seaweed, "data/seaweed_exp.rds")
```